<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fit-Insight Pro 2.0 | Final Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Pretendard', sans-serif; overflow: hidden; background-color: #f1f5f9; }
        
        /* ë ˆì´ì•„ì›ƒ */
        .layout-container { display: grid; grid-template-columns: 260px 1fr; grid-template-rows: 60px 1fr; height: 100vh; width: 100vw; }
        .top-nav { grid-column: 1 / -1; grid-row: 1 / 2; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .side-bar { grid-column: 1 / 2; grid-row: 2 / -1; z-index: 40; }
        .map-area { grid-column: 2 / -1; grid-row: 2 / -1; position: relative; }

        /* ê²€ìƒ‰ì°½ ìë™ì™„ì„± */
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px;
            background: white; border-radius: 12px;
            max-height: 320px; overflow-y: auto; 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2);
            z-index: 60; display: none; border: 1px solid #e2e8f0;
        }
        .search-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
        .search-item:hover { background-color: #f8fafc; padding-left: 20px; color: #3b82f6; }

        /* ìš°ì¸¡ íŒ¨ë„ (Glassmorphism) */
        .info-panel {
            position: absolute; top: 16px; right: 16px; width: 420px; bottom: 16px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 20px; box-shadow: -10px 0 40px rgba(0,0,0,0.1);
            transform: translateX(130%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 30; border: 1px solid rgba(255,255,255,0.5); display: flex; flex-direction: column;
        }
        .info-panel.active { transform: translateX(0); }

        /* ëª¨ë“œ ë²„íŠ¼ */
        .mode-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid transparent; }
        .mode-btn:hover { transform: translateY(-1px); }
        .mode-btn.active { border-color: #3b82f6; background-color: #eff6ff; color: #1d4ed8; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }

        /* ìŠ¬ë¼ì´ë” ì»¤ìŠ¤í…€ */
        .custom-range { appearance: none; -webkit-appearance: none; width: 100%; background: transparent; }
        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #ffffff; border: 2px solid #3b82f6; cursor: pointer; margin-top: -8px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .custom-range:active::-webkit-slider-thumb { transition: none; transform: scale(1.1); } /* ë“œë˜ê·¸ ì¤‘ ë¶€ë“œëŸ¬ì›€ ìœ ì§€ */
        .custom-range::-webkit-slider-thumb:hover { transform: scale(1.1); }
        .custom-range::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 3px;
        }

        /* ë§µ ì»¨íŠ¸ë¡¤ */
        .map-btn {
            background: white; width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; color: #475569; transition: all 0.2s;
        }
        .map-btn:hover { background: #3b82f6; color: white; transform: translateY(-2px); }
        
        .nav-pill {
            background: white; padding: 6px 16px; border-radius: 99px; font-weight: 700; font-size: 13px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); color: #334155; cursor: pointer; transition: all 0.2s;
        }
        .nav-pill:hover { background: #334155; color: white; }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-container { position: relative; height: 180px; width: 100%; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[100] transition-all duration-300 opacity-0 translate-y-4 pointer-events-none">
        <div class="bg-slate-800/90 text-white px-6 py-3 rounded-full shadow-2xl backdrop-blur-sm border border-slate-700 flex items-center gap-3">
            <i class="fa-solid fa-circle-exclamation text-yellow-400 text-lg"></i>
            <span id="toast-msg" class="text-sm font-medium tracking-wide">ì•Œë¦¼ ë©”ì‹œì§€</span>
        </div>
    </div>

    <div class="layout-container">
        <nav class="top-nav bg-slate-900 text-white flex items-center justify-between px-6 shadow-xl">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 w-9 h-9 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-layer-group text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tight leading-none">Fit-Insight <span class="text-blue-400 font-light">Pro</span></h1>
                </div>
            </div>

            <div class="relative w-[420px] hidden md:block group z-50">
                <input type="text" id="search-input" placeholder="ì§€ì—­(ê°•ë‚¨êµ¬) ë˜ëŠ” í—¬ìŠ¤ì¥ ì´ë¦„ ê²€ìƒ‰..." 
                    class="w-full bg-slate-800 border border-slate-700 text-white text-sm rounded-2xl py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-slate-900 transition-all placeholder-slate-500 shadow-inner"
                    oninput="handleSearchInput(this.value)">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-500 text-lg"></i>
                <div id="search-results" class="search-results"></div>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-xs font-medium text-slate-400 bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-700">
                    <i class="fa-solid fa-server mr-1.5 text-blue-500"></i>Data: <span id="data-count" class="text-white font-bold">Loading...</span>
                </div>
            </div>
        </nav>

        <aside class="side-bar bg-white border-r border-slate-200 flex flex-col z-40 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-5 border-b border-slate-100">
                <h2 class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest mb-4 pl-1">Analysis Mode</h2>
                
                <div class="space-y-3">
                    <button onclick="setMode('consumer')" id="btn-consumer" class="mode-btn active w-full p-4 rounded-2xl flex items-center gap-4 text-left bg-blue-50/50">
                        <div class="w-10 h-10 rounded-xl bg-white border border-green-100 text-green-600 flex items-center justify-center shadow-sm text-lg">
                            <i class="fa-solid fa-user-shield"></i>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-slate-800">ì†Œë¹„ì ì•ˆì „</div>
                            <div class="text-[10px] text-slate-500 font-medium mt-0.5">ë¨¹íŠ€ ë° íì—… ìœ„í—˜ ì§„ë‹¨</div>
                        </div>
                    </button>

                    <button onclick="setMode('startup')" id="btn-startup" class="mode-btn w-full p-4 rounded-2xl flex items-center gap-4 text-left">
                        <div class="w-10 h-10 rounded-xl bg-white border border-purple-100 text-purple-600 flex items-center justify-center shadow-sm text-lg">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-slate-800">ì˜ˆë¹„ ì°½ì—…ê°€</div>
                            <div class="text-[10px] text-slate-500 font-medium mt-0.5">ê°€ìƒ ì…ì§€ ìƒì¡´ìœ¨ ì‹œë®¬ë ˆì´ì…˜</div>
                        </div>
                    </button>

                    <button onclick="setMode('owner')" id="btn-owner" class="mode-btn w-full p-4 rounded-2xl flex items-center gap-4 text-left">
                        <div class="w-10 h-10 rounded-xl bg-white border border-orange-100 text-orange-600 flex items-center justify-center shadow-sm text-lg">
                            <i class="fa-solid fa-chart-pie"></i>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-slate-800">í˜„ì§ ì‚¬ì—…ì£¼</div>
                            <div class="text-[10px] text-slate-500 font-medium mt-0.5">ê²½ìŸì‚¬ ë¹„êµ ë° ì§„ë‹¨ ë¦¬í¬íŠ¸</div>
                        </div>
                    </button>
                </div>
            </div>

            <div class="p-5 flex-1 overflow-y-auto">
                <h2 class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest mb-4 pl-1">Map Filters</h2>
                <div class="space-y-3">
                    <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-100 hover:bg-slate-50 cursor-pointer transition">
                        <input type="checkbox" id="filter-24h" onchange="applyFilters()" class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                        <span class="text-sm font-bold text-slate-700">ğŸŒ™ 24ì‹œê°„ ìš´ì˜</span>
                    </label>
                </div>

                <div class="mt-8 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                    <h3 class="text-[11px] font-bold text-slate-500 mb-3 flex items-center"><i class="fa-solid fa-circle-info mr-1.5"></i> Marker Legend</h3>
                    <div class="space-y-2 text-xs font-medium text-slate-600">
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500 shadow-sm shadow-blue-500/50"></span> ì¼ë°˜ (ì˜ì—…ì¤‘)</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500 shadow-sm shadow-red-500/50"></span> ì„ íƒë¨ (ê°•ì¡°)</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-purple-500 shadow-sm shadow-purple-500/50"></span> ê°€ìƒ ì°½ì—…ì§€</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-slate-300"></span> íì—… (ë¶„ì„ìš©)</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="map-area">
            <div id="map" class="w-full h-full bg-slate-100"></div>

            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-20 flex gap-3">
                <div onclick="resetMap()" class="nav-pill flex items-center gap-2">
                    <i class="fa-solid fa-map"></i> ì„œìš¸ ì „ì²´
                </div>
                <div class="relative group">
                    <select id="district-select" onchange="moveToDistrict(this.value)" class="nav-pill appearance-none pr-8 pl-4 py-1.5 outline-none focus:ring-2 ring-blue-500">
                        <option value="">ìì¹˜êµ¬ ì´ë™ (Go to...)</option>
                        <option value="ê°•ë‚¨êµ¬">ê°•ë‚¨êµ¬</option><option value="ê°•ë™êµ¬">ê°•ë™êµ¬</option><option value="ê°•ë¶êµ¬">ê°•ë¶êµ¬</option>
                        <option value="ê°•ì„œêµ¬">ê°•ì„œêµ¬</option><option value="ê´€ì•…êµ¬">ê´€ì•…êµ¬</option><option value="ê´‘ì§„êµ¬">ê´‘ì§„êµ¬</option>
                        <option value="êµ¬ë¡œêµ¬">êµ¬ë¡œêµ¬</option><option value="ê¸ˆì²œêµ¬">ê¸ˆì²œêµ¬</option><option value="ë…¸ì›êµ¬">ë…¸ì›êµ¬</option>
                        <option value="ë„ë´‰êµ¬">ë„ë´‰êµ¬</option><option value="ë™ëŒ€ë¬¸êµ¬">ë™ëŒ€ë¬¸êµ¬</option><option value="ë™ì‘êµ¬">ë™ì‘êµ¬</option>
                        <option value="ë§ˆí¬êµ¬">ë§ˆí¬êµ¬</option><option value="ì„œëŒ€ë¬¸êµ¬">ì„œëŒ€ë¬¸êµ¬</option><option value="ì„œì´ˆêµ¬">ì„œì´ˆêµ¬</option>
                        <option value="ì„±ë™êµ¬">ì„±ë™êµ¬</option><option value="ì„±ë¶êµ¬">ì„±ë¶êµ¬</option><option value="ì†¡íŒŒêµ¬">ì†¡íŒŒêµ¬</option>
                        <option value="ì–‘ì²œêµ¬">ì–‘ì²œêµ¬</option><option value="ì˜ë“±í¬êµ¬">ì˜ë“±í¬êµ¬</option><option value="ìš©ì‚°êµ¬">ìš©ì‚°êµ¬</option>
                        <option value="ì€í‰êµ¬">ì€í‰êµ¬</option><option value="ì¢…ë¡œêµ¬">ì¢…ë¡œêµ¬</option><option value="ì¤‘êµ¬">ì¤‘êµ¬</option>
                        <option value="ì¤‘ë‘êµ¬">ì¤‘ë‘êµ¬</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 pointer-events-none"></i>
                </div>
            </div>

            <div class="absolute bottom-8 right-8 z-20 flex flex-col gap-3">
                <div onclick="map.setZoom(map.getZoom()+1)" class="map-btn" title="Zoom In"><i class="fa-solid fa-plus text-lg"></i></div>
                <div onclick="map.setZoom(map.getZoom()-1)" class="map-btn" title="Zoom Out"><i class="fa-solid fa-minus text-lg"></i></div>
            </div>

            <div id="info-panel" class="info-panel">
                <div class="p-6 border-b border-slate-100 flex-shrink-0">
                    <div class="flex justify-between items-start mb-2">
                        <span id="header-badge" class="px-3 py-1 rounded-full text-[11px] font-extrabold uppercase tracking-wide bg-slate-100 text-slate-500">Select Mode</span>
                        <button onclick="closePanel()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100 text-slate-400 transition"><i class="fa-solid fa-xmark text-lg"></i></button>
                    </div>
                    <h2 id="panel-title" class="text-2xl font-black text-slate-800 leading-tight mb-1 truncate">ë¶„ì„ ëª¨ë“œ ëŒ€ê¸°</h2>
                    <p id="panel-subtitle" class="text-xs font-medium text-slate-500 truncate">ì¢Œì¸¡ ë©”ë‰´ì—ì„œ ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                </div>
                <div id="panel-content" class="flex-1 overflow-y-auto p-6 scroll-smooth">
                    <div class="flex flex-col items-center justify-center h-full text-slate-400 opacity-60">
                        <i class="fa-solid fa-arrow-left text-3xl mb-4"></i>
                        <p class="text-sm font-medium">ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì—ì„œ<br>ì›í•˜ëŠ” ë¶„ì„ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="gym_data.js"></script>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
    
    <script>
        // --- System Config ---
        const API_KEY = "AIzaSyCAsmC4Oeqw9pEa-4x0rcFSNrhmKOcWrWU";
        const SEOUL_CENTER = { lat: 37.5665, lng: 126.9780 };
        
        // --- State Management ---
        let map, markerCluster, currentMarker;
        let markers = [];
        let highlightedMarker = null; // ê²€ìƒ‰ ê°•ì¡° ë§ˆì»¤
        let currentMode = 'consumer'; 
        let simState = { price: 70000, size: 80, is24h: false };
        let activeChart = null;
        let toastTimer = null;

        // [ìµœì í™”] ë””ë°”ìš´ìŠ¤ ìœ í‹¸ë¦¬í‹° (ìŠ¬ë¼ì´ë”ìš©)
        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        // [UX] í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showToast(message) {
            const toast = document.getElementById('toast');
            const msgBox = document.getElementById('toast-msg');
            msgBox.innerText = message;
            
            // Show
            toast.classList.remove('opacity-0', 'translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');
            
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                // Hide
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        }

        // --- Data Processor ---
        const Analyzer = {
            districtPrices: {},
            init: function(data) {
                const groups = {};
                data.forEach(g => {
                    const d = g.address ? g.address.split(' ')[1] : 'ê¸°íƒ€';
                    if (g.price_month > 0) {
                        if (!groups[d]) groups[d] = [];
                        groups[d].push(g.price_month);
                    }
                });
                for (const [k, v] of Object.entries(groups)) {
                    this.districtPrices[k] = Math.round(v.reduce((a, b) => a + b, 0) / v.length);
                }
            },
            analyzeConsumer: function(gym, compCount) {
                const dist = gym.address ? gym.address.split(' ')[1] : 'ê¸°íƒ€';
                const avg = this.districtPrices[dist] || 60000;
                let risk = 0, factors = [];
                if (gym.price_month > 0 && gym.price_month < avg * 0.5) { risk += 3; factors.push("ì´ˆì €ê°€ (ì‹œì„¸ 50% ë¯¸ë§Œ)"); }
                if (compCount >= 15) { risk += 2; factors.push(`ê³¼ë°€ ê²½ìŸ (${compCount}ê°œì†Œ)`); }
                if (!gym.franchise || gym.franchise.includes('ë¹„í”„ëœì°¨ì´ì¦ˆ')) { if(compCount >= 10) risk += 1; }
                return { risk, factors, avgPrice: avg };
            },
            analyzeStartup: function(compCount, dist, set) {
                const avg = this.districtPrices[dist] || 60000;
                let score = 60, advice = [];
                if (compCount >= 15) { score -= 30; advice.push("â›” ê²½ìŸ ê³¼ì—´ (Red Ocean)"); }
                else if (compCount <= 5) { score += 20; advice.push("âœ… ì„ ì  ê¸°íšŒ (Blue Ocean)"); }
                if (set.size >= 100) { score += 15; advice.push("â­ ëŒ€í˜• í‰ìˆ˜ ê²½ìŸë ¥ í™•ë³´"); }
                if (set.is24h) { score += 15; advice.push("ğŸŒ™ 24ì‹œê°„ ìš´ì˜ ë©”ë¦¬íŠ¸"); }
                const pRatio = set.price / avg;
                if(pRatio > 1.5) { score -= 10; advice.push("ğŸ’¸ ê°€ê²© ì €í•­ ì˜ˆìƒ (ê³ ê°€)"); }
                else if(pRatio < 0.6) { score -= 15; advice.push("ğŸ’¸ ìˆ˜ìµì„± ì €í•˜ ìš°ë ¤ (ì €ê°€)"); }
                return { score: Math.max(10, Math.min(99, score)), advice, avgPrice: avg };
            },
            analyzeOwner: function(gym, comps) {
                const dist = gym.address ? gym.address.split(' ')[1] : 'ê¸°íƒ€';
                const avg = this.districtPrices[dist] || 60000;
                const valid = comps.filter(c => c.price_month > 0);
                let rank = 50;
                if(gym.price_month > 0 && valid.length > 0) {
                    const sorted = [...valid, gym].sort((a,b) => a.price_month - b.price_month);
                    rank = Math.round(((sorted.indexOf(gym) + 1) / sorted.length) * 100);
                }
                return { compCount: comps.length, priceRank: rank, avgPrice: avg };
            }
        };

        // --- Init ---
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initApp&libraries=geometry`;
        script.async = true;
        document.body.appendChild(script);

        function initApp() {
            if (typeof gymData !== 'undefined') {
                document.getElementById('data-count').innerText = gymData.length.toLocaleString();
                Analyzer.init(gymData);
            }
            initMap();
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: SEOUL_CENTER, zoom: 12, // ì´ˆê¸° ì¤Œ ë ˆë²¨ ì¡°ì •
                disableDefaultUI: true, mapId: "4504f8b37365c3d0", gestureHandling: "greedy"
            });
            // ì°½ì—… ëª¨ë“œ: ë¹ˆ ê³µê°„ í´ë¦­ ë¦¬ìŠ¤ë„ˆ
            map.addListener("click", (e) => {
                if(currentMode === 'startup') runStartupSim(e.latLng);
            });
            renderMarkers();
        }

        function renderMarkers() {
            if (markerCluster) markerCluster.clearMarkers();
            markers = [];
            const baseIcon = { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillOpacity: 1, strokeWeight: 2, strokeColor: "white" };

            markers = gymData.map((gym, index) => {
                let color = "#3B82F6"; // Default Blue
                if(gym.status === 'closed') color = "#CBD5E1";
                else if(currentMode === 'owner') color = "#F97316"; 
                else if(currentMode === 'startup') color = "#94A3B8"; 
                else if(currentMode === 'consumer') {
                     const d = gym.address ? gym.address.split(' ')[1] : 'ê¸°íƒ€';
                     const avg = Analyzer.districtPrices[d] || 60000;
                     if(gym.price_month > 0 && gym.price_month < avg*0.5) color = "#F59E0B"; 
                }

                const marker = new google.maps.Marker({
                    position: { lat: gym.lat, lng: gym.lng },
                    title: gym.name,
                    icon: { ...baseIcon, fillColor: color, scale: currentMode==='startup'?5:8 },
                    zIndex: 1
                });

                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                marker.addListener("click", (e) => {
                    e.stop();
                    // ê²€ìƒ‰ ê°•ì¡° í•´ì œ
                    resetHighlight();

                    if(currentMode === 'startup') {
                        // [UX] ê²½ê³ ì°½ ëŒ€ì‹  í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì¶œë ¥
                        showToast("âš ï¸ ì´ë¯¸ ìš´ì˜ ì¤‘ì¸ ì‹œì„¤ì…ë‹ˆë‹¤. ì§€ë„ì˜ 'ë¹ˆ ê³³'ì„ í´ë¦­í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜ì„ ì§„í–‰í•˜ì„¸ìš”.");
                    } else if(currentMode === 'consumer') {
                        runConsumerViz(gym);
                    } else if(currentMode === 'owner') {
                        runOwnerViz(gym);
                    }
                });
                return marker;
            });

            markerCluster = new markerClusterer.MarkerClusterer({ map, markers, algorithmOptions: { maxZoom: 14 } });
        }

        // [UX] ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ (Highlight & Center)
        function handleSearchClick(lat, lng, name) {
            document.getElementById('search-results').style.display = 'none';
            
            // 1. ë‹¨ìˆœ ì¤‘ì•™ ì´ë™ (ì˜¤í”„ì…‹ ì—†ì´ ì •ì¤‘ì•™)
            map.panTo({lat, lng});
            map.setZoom(16);

            // 2. ë§ˆì»¤ ì°¾ê¸° ë° ê°•ì¡°
            const targetIndex = gymData.findIndex(g => g.name === name);
            if (targetIndex !== -1 && markers[targetIndex]) {
                const targetMarker = markers[targetIndex];
                resetHighlight();
                
                highlightedMarker = targetMarker;
                // ê°•ì¡° ìŠ¤íƒ€ì¼ (ì»¤ë‹¤ë€ ë¹¨ê°„ í•€)
                targetMarker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 14, fillColor: "#EF4444", fillOpacity: 1, strokeWeight: 4, strokeColor: "white"
                });
                targetMarker.setZIndex(9999);
                targetMarker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => targetMarker.setAnimation(null), 2100); // 3ë²ˆ ë°”ìš´ìŠ¤ í›„ ì •ì§€

                // íŒ¨ë„ ì—´ê¸°
                if(currentMode === 'consumer') runConsumerViz(gymData[targetIndex]);
                else if(currentMode === 'owner') runOwnerViz(gymData[targetIndex]);
            }
        }

        function resetHighlight() {
            if (highlightedMarker) {
                // ì›ë˜ëŒ€ë¡œ ë³µêµ¬í•˜ë ¤ë©´ ì „ì²´ ë¦¬ë Œë”ë§ì´ ê°€ì¥ ì•ˆì „í•¨ (ìƒ‰ìƒ ë“± ìƒíƒœ ì˜ì¡´ì ì´ë¯€ë¡œ)
                renderMarkers(); 
                highlightedMarker = null;
            }
        }

        // --- Visualizations & UI ---

        function runConsumerViz(gym) {
            let comps = getCompetitors(gym.lat, gym.lng).length;
            const res = Analyzer.analyzeConsumer(gym, comps);
            updateHeader("ì†Œë¹„ì ì•ˆì „ ì§„ë‹¨", gym.name, "bg-green-100 text-green-700");

            const riskColor = res.risk >= 3 ? "text-red-500" : (res.risk >= 1 ? "text-yellow-500" : "text-green-500");
            const riskText = res.risk >= 3 ? "ê³ ìœ„í—˜êµ°" : (res.risk >= 1 ? "ì£¼ì˜ë‹¨ê³„" : "ì•ˆì „ì‹œì„¤");

            document.getElementById('panel-content').innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <div class="text-xs text-slate-400 font-bold uppercase">Safety Score</div>
                        <div class="text-3xl font-black ${riskColor}">${riskText}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-slate-400 font-bold uppercase">Price/Month</div>
                        <div class="text-xl font-bold text-slate-800">${gym.price_month.toLocaleString()}ì›</div>
                    </div>
                </div>
                 ${res.factors.length > 0 ? `
                <div class="bg-red-50 p-4 rounded-2xl border border-red-100 mb-6">
                    <h4 class="text-xs font-bold text-red-600 mb-2 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Risk Factors</h4>
                    <ul class="text-xs text-red-800 space-y-1 list-disc list-inside font-medium">
                        ${res.factors.map(f=>`<li>${f}</li>`).join('')}
                    </ul>
                </div>` : ''}
                <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                    <h4 class="text-xs font-bold text-slate-500 mb-4 uppercase">Market Context</h4>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-xs font-bold mb-1">
                                <span class="text-slate-600">ê°€ê²© í¬ì§€ì…˜</span>
                                <span class="text-blue-500">ì§€ì—­í‰ê· : ${res.avgPrice.toLocaleString()}ì›</span>
                            </div>
                            <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                                <div class="bg-blue-500 h-full rounded-full" style="width: ${Math.min(100, (gym.price_month/res.avgPrice)*100)}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs font-bold mb-1">
                                <span class="text-slate-600">ê²½ìŸ ë°€ì§‘ë„</span>
                                <span class="${comps>=15?'text-red-500':'text-green-500'}">${comps}ê°œì†Œ (500m)</span>
                            </div>
                            <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                                <div class="${comps>=15?'bg-red-500':'bg-green-500'} h-full rounded-full" style="width: ${Math.min(100, (comps/20)*100)}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            openPanel();
        }

        function runStartupSim(latLng) {
            const comps = getCompetitors(latLng.lat(), latLng.lng());
            const dName = "ì„ íƒ ì§€ì—­"; 

            if(currentMarker) currentMarker.setMap(null);
            currentMarker = new google.maps.Marker({
                position: latLng, map: map,
                icon: { path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, scale: 6, fillColor: "#8B5CF6", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" },
                animation: google.maps.Animation.DROP
            });

            // [ìµœì í™”] ì‹¤ì œ ê³„ì‚° ë° ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ë¬´ê±°ìš´ ì‘ì—…)
            const performRender = () => {
                const res = Analyzer.analyzeStartup(comps.length, dName, simState);
                updateHeader("ì°½ì—… ìƒì¡´ìœ¨ ì‹œë®¬ë ˆì´í„°", "ì‹ ê·œ ì…ì  ë¶„ì„", "bg-purple-100 text-purple-700");
                const scoreColor = res.score>=70?'#22c55e':(res.score>=40?'#eab308':'#ef4444');

                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                if(activeChart) activeChart.destroy();
                const ctx = document.getElementById('scoreChart').getContext('2d');
                activeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Success', 'Risk'],
                        datasets: [{ data: [res.score, 100-res.score], backgroundColor: [scoreColor, '#e2e8f0'], borderWidth: 0, cutout: '85%' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
                });
                
                // ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸
                const scoreDisplay = document.getElementById('score-display');
                if(scoreDisplay) {
                    scoreDisplay.innerText = res.score;
                    scoreDisplay.style.color = scoreColor;
                }
                const insightList = document.getElementById('insight-list');
                if(insightList) insightList.innerHTML = res.advice.map(a=>`<div>â€¢ ${a}</div>`).join('');
            };

            // ë””ë°”ìš´ìŠ¤ ì ìš©
            const debouncedRender = debounce(performRender, 300);

            // ì´ˆê¸° UI ë¹Œë“œ
            window.renderStartup = () => {
                const res = Analyzer.analyzeStartup(comps.length, dName, simState); // ì´ˆê¸°ê°’ìš©
                const scoreColor = res.score>=70?'#22c55e':(res.score>=40?'#eab308':'#ef4444');

                document.getElementById('panel-content').innerHTML = `
                    <div class="text-center mb-8 relative">
                         <div class="chart-container flex justify-center items-center">
                            <canvas id="scoreChart"></canvas>
                            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <div id="score-display" class="text-4xl font-black text-slate-800" style="color:${scoreColor}">${res.score}</div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase">Success Rate</div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-6 mb-8 px-2">
                        <div>
                            <div class="flex justify-between text-xs font-bold text-slate-600 mb-2">
                                <span>ì›” íšŒì›ê¶Œ ê°€ê²©</span>
                                <span id="val-price" class="text-purple-600">${simState.price.toLocaleString()}ì›</span>
                            </div>
                            <input type="range" min="30000" max="150000" step="5000" value="${simState.price}" 
                                oninput="simState.price=parseInt(this.value); document.getElementById('val-price').innerText=parseInt(this.value).toLocaleString()+'ì›'; window.debouncedStartupRender();" 
                                class="custom-range">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs font-bold text-slate-600 mb-2">
                                <span>ë§¤ì¥ ê·œëª¨ (í‰)</span>
                                <span id="val-size" class="text-purple-600">${simState.size}í‰</span>
                            </div>
                            <input type="range" min="30" max="300" step="10" value="${simState.size}" 
                                oninput="simState.size=parseInt(this.value); document.getElementById('val-size').innerText=this.value+'í‰'; window.debouncedStartupRender();" 
                                class="custom-range">
                        </div>
                         <div class="flex items-center justify-between p-4 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-purple-300 transition shadow-sm" onclick="simState.is24h=!simState.is24h; renderStartup();">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center"><i class="fa-solid fa-clock"></i></div>
                                <span class="text-sm font-bold text-slate-700">24ì‹œê°„ ìš´ì˜</span>
                            </div>
                            <div class="w-10 h-6 ${simState.is24h?'bg-purple-600':'bg-slate-200'} rounded-full relative transition-colors">
                                <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-all ${simState.is24h?'left-5':'left-1'} shadow-sm"></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-purple-50 p-5 rounded-2xl border border-purple-100">
                        <h4 class="text-xs font-bold text-purple-800 mb-3 uppercase flex items-center"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>AI Insights</h4>
                        <div id="insight-list" class="space-y-2 text-xs text-purple-900 font-medium">
                            ${res.advice.map(a=>`<div>â€¢ ${a}</div>`).join('')}
                        </div>
                    </div>
                `;
                // ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜ ì „ì—­ ë“±ë¡
                window.debouncedStartupRender = debouncedRender;
                // ì´ˆê¸° ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                performRender();
            };
            
            renderStartup();
            openPanel();
        }

        function runOwnerViz(gym) {
            const comps = getCompetitors(gym.lat, gym.lng);
            const res = Analyzer.analyzeOwner(gym, comps);
            updateHeader("ë‚´ í—¬ìŠ¤ì¥ ê²½ìŸë ¥ ì§„ë‹¨", gym.name, "bg-orange-100 text-orange-700");

            document.getElementById('panel-content').innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                        <div class="text-xs text-slate-400 font-bold uppercase mb-1">Competitors</div>
                        <div class="text-2xl font-black text-slate-800">${res.compCount}</div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                        <div class="text-xs text-slate-400 font-bold uppercase mb-1">Price Rank</div>
                        <div class="text-2xl font-black text-orange-600">Top ${res.priceRank}%</div>
                    </div>
                </div>
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-slate-500 mb-3 uppercase pl-1">Price Comparison</h4>
                    <div class="chart-container h-48"><canvas id="priceChart"></canvas></div>
                </div>
                <div class="bg-orange-50 p-5 rounded-2xl border border-orange-100">
                    <h4 class="text-xs font-bold text-orange-800 mb-2 uppercase">Diagnostic Report</h4>
                    <p class="text-xs text-orange-900 leading-relaxed font-medium">
                        í˜„ì¬ ì§€ì—­ í‰ê·  ì‹œì„¸(${res.avgPrice.toLocaleString()}ì›) ëŒ€ë¹„ 
                        <strong>${gym.price_month > res.avgPrice ? 'ë†’ì€ ê°€ê²©' : 'ë‚®ì€ ê°€ê²©'}</strong>ì„ í˜•ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            `;
            if(activeChart) activeChart.destroy();
            const ctx = document.getElementById('priceChart').getContext('2d');
            activeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ë‚´ í—¬ìŠ¤ì¥', 'ì§€ì—­ í‰ê· ', 'ìµœì €ê°€'],
                    datasets: [{ label: 'ì›” íšŒì›ê¶Œ ê°€ê²©', data: [gym.price_month, res.avgPrice, 30000], backgroundColor: ['#f97316', '#cbd5e1', '#e2e8f0'], borderRadius: 8, barThickness: 40 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
            });
            openPanel();
        }

        // --- Helpers ---
        function getCompetitors(lat, lng) {
            return gymData.filter(g => google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(lat,lng), new google.maps.LatLng(g.lat,g.lng)) <= 500);
        }

        function updateHeader(badge, title, badgeClass) {
            document.getElementById('header-badge').className = `px-3 py-1 rounded-full text-[11px] font-extrabold uppercase tracking-wide ${badgeClass}`;
            document.getElementById('header-badge').innerText = badge;
            document.getElementById('panel-title').innerText = title;
        }

        function openPanel() { document.getElementById('info-panel').classList.add('active'); }
        window.closePanel = function() { document.getElementById('info-panel').classList.remove('active'); }
        
        window.setMode = function(mode) {
            currentMode = mode;
            ['consumer', 'startup', 'owner'].forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                if(m===mode) btn.classList.add('active'); else btn.classList.remove('active');
            });
            if(currentMarker) currentMarker.setMap(null);
            closePanel(); renderMarkers();
        }

        window.handleSearchInput = function(q) {
            const resDiv = document.getElementById('search-results');
            if(!q || q.length < 2) { resDiv.style.display='none'; return; }
            const hits = gymData.filter(g => g.name.includes(q) || (g.address && g.address.includes(q))).slice(0,6);
            if(hits.length>0) {
                resDiv.style.display='block';
                // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ handleSearchClick í˜¸ì¶œ
                resDiv.innerHTML = hits.map(g => `
                    <div class="search-item" onclick="handleSearchClick(${g.lat}, ${g.lng}, '${g.name}')">
                        <div class="font-bold text-slate-800 text-sm">${g.name}</div>
                        <div class="text-xs text-slate-400">${g.address?g.address.split(' ')[1]:''}</div>
                    </div>`).join('');
            } else resDiv.style.display='none';
        }
        
        // [UX] ì„œìš¸ ì „ì²´ ë³´ê¸° (ë‹¨ìˆœí™”ëœ ì¤‘ì•™ ì •ë ¬)
        window.resetMap = function() { 
            const center = new google.maps.LatLng(SEOUL_CENTER.lat, SEOUL_CENTER.lng);
            map.panTo(center); 
            map.setZoom(12);
        }
        
        window.moveToDistrict = function(d) { 
            if(d){ 
                const t=gymData.find(g=>g.address&&g.address.includes(d)); 
                if(t){ map.panTo({lat:t.lat,lng:t.lng}); map.setZoom(14); } 
            } 
        }
        function applyFilters(){ renderMarkers(); }
    </script>
</body>
</html>